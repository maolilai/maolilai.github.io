---
layout: post
title:  "å€¾å‘æ€§å¾—åˆ†ç ”ç©¶åˆ†æ"
date:   2021-03-27 00:10:01
categories: æ¢ç´¢
comment: true
reward: true
tags: ç ”ç©¶
excerpt: è¿™æ˜¯è¿™ç¯‡æ–‡ç« çš„æ‘˜è¦ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥åœ¨æ–‡ç« æ­£æ–‡ä¸­ä½¿ç”¨ <!--more--> æ ‡ç­¾æ¥æˆªæ–­æ‘˜è¦ã€‚
---

# å€¾å‘æ€§å¾—åˆ†ç ”ç©¶åˆ†æ

## æ–‡ç« åœ°å€
https://dango.rocks/blog/2019/01/20/Causal-Inference-Introduction2-Propensity-Score-Matching/


https://cloud.tencent.com/developer/article/1465008


```

---
title: "Causal Inference Introduction2: Propensity Score Matching"
output: html_document
editor_options:
chunk_output_type: console
---


  ```{r setup, include=FALSE}
install.packages("rmarkdown", repos="https://cloud.r-project.org")

install.packages("knitr")
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
install.packages("data.table")
library(data.table)
install.packages("weights")
library(weights)
install.packages("MatchIt")
library(MatchIt)
install.packages("knitr")
library(knitr)
```

## Load the dataset

Datasets

- Paper: Dehejia R H, Wahba S. Causal effects in nonexperimental studies: Reevaluating the evaluation of training programs[J]. Journal of the American statistical Association, 1999, 94(448): 1053-1062. (http://www.uh.edu/~adkugler/Dehejia&Wahba_JASA.pdf)
- Download: http://users.nber.org/~rdehejia/nswdata2.html


```{r load}
# Load the datsets

library(data.table)
col.names=c('treat', 'age', 'educ', 'black', 'hispan', 'married', 'nodegree', 're74', 're75', 're78')
dir <- './dataset/'
nsw_treated <- fread(paste0(dir, 'nswre74_treated.txt'), col.names = col.names)
nsw_control <- fread(paste0(dir, 'nswre74_control.txt'), col.names = col.names)
cps1_control <- fread(paste0(dir, 'cps3_controls.txt'), col.names = col.names)
cps3_control <- fread(paste0(dir, 'cps3_controls.txt'), col.names = col.names)
# Combine all the datasets
nsw_data_exp <- rbind(nsw_treated, nsw_control)
nsw_data_exp[, dataset := 'NSW-Data-Exp']
nsw_data_obs <- rbind(nsw_treated, cps3_control)
nsw_data_obs[, dataset := 'NSW-Data-Obs']
data <- rbind(nsw_data_exp, nsw_data_obs)
```

Check the sample mean.

```{r pre_treatment}
get.mean.se <- function(x) {
  mean = round(mean(x), 2)
  se = round(sd(x)/sqrt(length(x)), 2)
  return(paste0(mean, '(', se, ')'))
}
results <-  merge(
  data[, .(`no. obs`=.N), by = .(dataset, treat)],
  data[, lapply(.SD, get.mean.se), by = .(dataset, treat)]
)
tmp <- t(results[, 2:ncol(results)])
colnames(tmp) <- results$dataset
kable(tmp)
```

Estimate the Average Treatment Effect on the Treated (ATT).

```{r}
t.test(nsw_data_exp[treat==1, re78], nsw_data_exp[treat==0, re78])
```

## Observational Study: Propensity Score Matching

### Propensity score matching

```{r load}
set.seed(42)
m.out <- matchit(data = nsw_data_obs,
                 formula = treat ~ age + I(age^2) + I(age^3) + educ +
                   black + hispan + married +
                   I(re74/1000) + I(re75/1000),
                 method = "nearest",
                 distance = "logit",
                 replace = FALSE,
                 caliper = 0.05)
summary(m.out)
```

### Access Balance

```{r}
plot(m.out, type = "hist", interactive = F)
plot(m.out, type = "QQ", interactive = F, which.xs = c("age", "I(re74/1000)", "I(re75/1000)"))
summary(m.out, standardize = T)$sum.matched
```

### Causal Effect Estimation

```{r}
m.data <- match.data(m.out)
# Direct compare
res <- wtd.t.test(m.data$re78[m.data$treat == 1],
                  m.data$re78[m.data$treat == 0],
                  weight = m.data$weights[m.data$treat == 1],
                  weighty = m.data$weights[m.data$treat == 0])
print(res)
mu <- res$additional[1]
std <- res$additional[4]
cat("Confidence interval: ", sapply(qt(c(0.025, 0.975), coef(res)["df"]), function(x){return(mu+x*std)}), "\n")
# Fit
att.fml <- re78 ~ treat + age + educ + black + hispan + married + nodegree + re74 + re75
fit <- lm(att.fml, data = m.data, weights = m.data$weights)
summary(fit)
cat("Confidence interval: ", confint(fit, "treat", 0.95), "\n")
```


rmarkdown::render('psm.Rmd', 'html_document')


```



åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  ã€Šå› æœæ¨æ–­æ¼«è°ˆï¼ˆä¸€ï¼‰ï¼šæ€å¼€ â€œå› æœæ¨æ–­â€ çš„é¢çº±ã€‹ ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»äº†æ½œåœ¨ç»“æœæ¨¡å‹ã€æ½œåœ¨ç»“æœæ¨¡å‹ä¸­å› æœæ•ˆåº”çš„å®šä¹‰ï¼Œä»¥åŠå› æœæ•ˆåº”çš„å¯è¯†åˆ«æ€§ã€‚
è¿™ä¸€ç¯‡æ–‡ç« æ¥ç®€å•ä»‹ç»ä¸€ä¸‹ â€œå€¾å‘æ€§å¾—åˆ†åŒ¹é…â€ï¼ˆPropensity Score Matchingï¼‰ï¼Œä¸€ä¸ªå¤„ç†è§‚å¯Ÿæ€§ç ”ç©¶ï¼ˆobservational studyï¼‰çš„ç»å…¸æ–¹æ³•ã€‚

å› æœæ¨æ–­æ•°æ®é›†
åœ¨ä»‹ç»å€¾å‘æ€§å¾—åˆ†åŒ¹é…ä¹‹å‰ï¼Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸ªè§‚å¯Ÿæ€§ç ”ç©¶ä¸­éå¸¸ç»å…¸çš„æ•°æ®é›†ï¼šThe NSW Datasetã€‚
è¿™ä»½æ•°æ®æœ€æ—©æ˜¯ Robert Lalonde åœ¨è®ºæ–‡ [1] ä¸­ä½¿ç”¨çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ•°æ®é›†æœ‰çš„æ—¶å€™ä¹Ÿè¢«ç›´æ¥æˆä¸º â€œLalondeâ€ã€‚
è¿™ä»½æ•°æ®æ ¹æ®æ ·æœ¬å±æ€§çš„é½å…¨ç¨‹åº¦æœ‰å‡ ä¸ªä¸åŒçš„ç‰ˆæœ¬ã€‚
å®Œæ•´çš„æƒ…å†µå¯ä»¥å‚è€ƒ NSW Dataã€‚

éšæœºå®éªŒæ•°æ® NSW Data Files (Dehejia-Wahha Sample) æ˜¯åŸå§‹çš„ Lalondeâ€™s NSW experimental data ä¸­ï¼Œæ ·æœ¬ 1974 å¹´æ”¶å…¥å·²çŸ¥çš„ä¸€éƒ¨åˆ†ã€‚

å®éªŒç»„ï¼šnswre74_treated.txt (185 observations)
å¯¹ç…§ç»„ï¼šnswre74_control.txt (260 observations)
â€œè§‚å¯Ÿæ€§ç ”ç©¶â€ æ•°æ®çš„æ„é€ æ–¹å¼æ˜¯å–éšæœºå®éªŒä¸­çš„å®éªŒç»„ï¼Œå†æ­é…ä¸Šä¸€ä¸ªé€šè¿‡å…¶ä»–æ¸ é“è·å¾—çš„å¯¹ç…§ç»„ã€‚
åœ¨ R çš„éå¸¸å¥½ç”¨çš„å€¾å‘æ€§å¾—åˆ†åŒ¹é… MatchIt åŒ…é‡Œé™„å¸¦çš„æ•°æ®æ˜¯ä»¥ä¸‹è¿™ä¸ªç‰ˆæœ¬ï¼š

å®éªŒç»„ï¼šnswre74_treated.txt (185 observations)
å¯¹ç…§ç»„ï¼šcps3_controls.txt (429 observations)
åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬æŠŠéšæœºå®éªŒæ•°æ®ç§°ä¸º NSW-Data-Expï¼ŒæŠŠè§‚å¯Ÿæ€§ç ”ç©¶æ•°æ®ç§°ä¸º NSW-Data-Obsã€‚

æˆ‘ä»¬å…ˆçœ‹çœ‹æ•°æ®é›†é‡Œå…·ä½“éƒ½æœ‰äº›ä»€ä¹ˆã€‚

å¹²é¢„ ğ‘‡: treat ï¼ˆæ˜¯å¦æ¥å—äº†å°±ä¸šåŸ¹è®­ï¼‰
æ ·æœ¬å±æ€§ ğ‘‹: age, educ, black, hispan, married, nodegree (æ²¡æœ‰å­¦ä½), re74
(1974 å¹´çš„æ”¶å…¥), re75 (1975 å¹´çš„æ”¶å…¥)
è§‚å¯Ÿç»“æœ ğ‘Œ: re78 (1978 å¹´çš„æ”¶å…¥)
ä¸‹è¡¨æ˜¯æ¯ä¸€ä¸ªæ•°æ®é›†æŒ‰ç…§ treat åˆ†ç»„åçš„ç»Ÿè®¡ç»“æœã€‚

éšæœºå®éªŒæ•°æ® NSW-Data-Exp ä¸­ï¼šå®éªŒç»„å’Œå¯¹ç…§ç»„æ ·æœ¬çš„å„ç±»å±æ€§éƒ½æ˜¯å¾ˆæ¥è¿‘çš„ï¼Œå®éªŒç»„ 78 å¹´çš„æ”¶å…¥æ¯”å¯¹ç…§ç»„é«˜ 1794 ç¾å…ƒï¼Œå¯ä»¥è®¤ä¸ºæ˜¯å°±ä¸šåŸ¹è®­å¸¦æ¥çš„å› æœæ•ˆåº”ã€‚
è§‚å¯Ÿæ€§ç ”ç©¶æ•°æ® NSW-Data-Obs ä¸­ï¼š å®éªŒåï¼Œå®éªŒç»„ç”¨æˆ·çš„æ”¶å…¥æ¯”å¯¹ç…§ç»„ä½ 635 ç¾é‡‘ï¼Œå®¹æ˜“é€ æˆ â€œå°±ä¸šåŸ¹è®­å¯¼è‡´æ”¶å…¥ä¸‹é™â€ çš„å¹»è§‰ï¼Œä½†æ˜¯ä»”ç»†ä¸€çœ‹ï¼Œå®éªŒç»„ç”¨æˆ·åœ¨å®éªŒå‰çš„æ”¶å…¥ä¹Ÿæ¯”å¯¹ç…§ç»„ä½å¾ˆå¤šï¼Œæ‰€ä»¥ä¸¤ç»„ç”¨æˆ·å®éªŒåçš„æ”¶å…¥æœ¬æ¥å°±æ²¡æœ‰ä»€ä¹ˆå¯æ¯”æ€§ã€‚
NSW-Data-Exp	NSW-Data-Exp	NSW-Data-Obs	NSW-Data-Obs
treat	0	1	0	1
no. obs	260	185	429	185
age	25.05(0.44)	25.82(0.53)	28.03(0.52)	25.82(0.53)
educ	10.09(0.1)	10.35(0.15)	10.24(0.14)	10.35(0.15)
black	0.83(0.02)	0.84(0.03)	0.2(0.02)	0.84(0.03)
hispan	0.11(0.02)	0.06(0.02)	0.14(0.02)	0.06(0.02)
married	0.15(0.02)	0.19(0.03)	0.51(0.02)	0.19(0.03)
nodegree	0.83(0.02)	0.71(0.03)	0.6(0.02)	0.71(0.03)
re74	2107.03(352.75)	2095.57(359.27)	5619.24(327.76)	2095.57(359.27)
re75	1266.91(192.44)	1532.06(236.68)	2466.48(158.94)	1532.06(236.68)
re78	4554.8(340.09)	6349.14(578.42)	6984.17(352.17)	6349.14(578.42)
åœ¨äº’è”ç½‘å…¬å¸é‡Œåšæ•°æ®åˆ†ææ—¶ï¼Œæ—¥å¸¸æ•°æ®åˆ†æå·¥ä½œé‡Œä¹Ÿå¸¸å¸¸é‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼š
å½“æˆ‘ä»¬æƒ³è¦åˆ†æä¸€ä¸ªäº§å“ç‰¹æ€§ã€ä¸€ä¸ªæ¨èç­–ç•¥ã€ä¸€ä¸ªå¹¿å‘ŠæŠ•æ”¾æ•ˆæœå¥½ä¸å¥½æ—¶ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå°è¯•å¾€å¾€æ˜¯æŠŠç”¨æˆ·æ ¹æ®æœ‰æ²¡æœ‰å‘½ä¸­æˆ–è€…æœ‰æ²¡æœ‰æ›å…‰ åˆ†æˆ â€œæœ‰â€ å’Œ â€œæ²¡æœ‰â€ ä¸¤ç»„ã€‚
è€Œåœ¨å¤§éƒ¨åˆ†æ—¶å€™ï¼Œè¿™ä¸¤ç»„ç”¨æˆ·æ˜¯è¶…çº§ä¸åŒè´¨çš„ï¼ˆä¾‹å¦‚è¢«æŠ•æ”¾å¹¿å‘Šçš„ç”¨æˆ·å¯èƒ½æ˜¯ç²¾æŒ‘ç»†é€‰çš„é«˜æ½œåŠ›ç›®æ ‡ç”¨æˆ·ï¼‰ï¼Œæ‰€ä»¥æ¯”è¾ƒèµ·æ¥ä¹Ÿæ²¡æœ‰å¤šå¤§æ„ä¹‰ã€‚

å€¾å‘æ€§å¾—åˆ†åŒ¹é…
ä¸è®ºåœ¨ NSW-Data-Obs è¿™ä¸ªæ•°æ®é›†é‡Œï¼Œè¿˜æ˜¯åœ¨ä¸Šé¢æåˆ°çš„æ•°æ®åˆ†æå·¥ä½œé‡åˆ°çš„é—®é¢˜é‡Œï¼Œæˆ‘ä»¬é‡åˆ°çš„é—®é¢˜æœ¬è´¨ä¸Šéƒ½æ˜¯æƒ³è¦æ¯”è¾ƒçš„ä¸¤ä¸ªäººç¾¤ä¸åŒè´¨ã€‚
å¦‚æœæˆ‘ä»¬æƒ³è¦æ¶ˆé™¤ä¸¤ä¸ªäººç¾¤ä¹‹é—´çš„ä¸åŒè´¨ï¼Œè®©ä¸¤ä¸ªäººç¾¤ä¹‹é—´å¯ä»¥æ¯”è¾ƒï¼Œæˆ‘ä»¬å¯ä»¥æ€ä¹ˆåšå‘¢ï¼Ÿ

ä¸€ä¸ªç²—æš´çš„æ€è·¯æ˜¯å°†å®éªŒç»„å’Œå¯¹ç…§ç»„çš„æ ·æœ¬åšä¸€ä¸‹ â€œåŒ¹é…â€ã€‚
ä¾‹å¦‚ï¼Œå¯¹äºå®éªŒç»„çš„æ¯ä¸€ä¸ªæ ·æœ¬ï¼Œæˆ‘ä»¬éƒ½å»å¯¹ç…§ç»„é‡Œæ‰¾ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„æ ·æœ¬ã€‚
å½“æ ·æœ¬å±æ€§å…¨éƒ¨éƒ½æ˜¯ç¦»æ•£çš„ï¼Œå¹¶ä¸”å±æ€§çš„ç»´åº¦ï¼ˆä¸ªæ•°ï¼‰å¾ˆå°çš„æ—¶å€™ï¼Œè¿™ä¹ˆåšä¹Ÿè®¸æ˜¯å¯ä»¥çš„ã€‚
å½“æ ·æœ¬å±æ€§é‡Œæœ‰ä¸€äº›è¿ç»­å˜é‡æˆ–è€…å½“æ ·æœ¬å±æ€§çš„ç»´åº¦å¾ˆé«˜æ—¶ï¼Œè¿™ä¹ˆåšå¤ªç²—æš´äº†ï¼Œå¤§éƒ¨åˆ†äººæ˜¯æ‰¾ä¸åˆ°åŒ¹é…å¯¹è±¡çš„ã€‚

â€œå€¾å‘æ€§å¾—åˆ†åŒ¹é…â€ï¼Œç®€å•è€Œè¨€ï¼Œæ˜¯ä¸€ç§æ›´åŠ é è°±çš„æ‰¾å¯¹è±¡æ–¹æ¡ˆã€‚
åœ¨ä»‹ç» â€œå€¾å‘æ€§å¾—åˆ†åŒ¹é…â€ çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹ŸåŒæ­¥ç”¨ç»å…¸çš„ NSW-Data-obs åšä¸€ä»½æ•°æ®åˆ†æã€‚
åšåˆ†ææ—¶ï¼Œä½¿ç”¨ R çš„ MatchIt åŒ… [6]ï¼Œå®Œæ•´çš„ Rmarkdown è§
yishilin14/causal_playgroundã€‚

å¯¹äºäº’è”ç½‘å…¬å¸çš„æˆ‘ï¼Œâ€œæ ·æœ¬â€ å’Œ â€œæ ·æœ¬å±æ€§â€ è¿™äº›åè¯æœ‰ä¸€äº›è·ç¦»æ„Ÿï¼Œä¸‹æ–‡é‡Œç”¨ â€œç”¨æˆ·â€ å’Œ â€œç‰¹å¾â€ ä»£æ›¿ï¼ŒåŠ å¼ºä¸€ä¸‹ä»£å…¥æ„Ÿã€‚

å€¾å‘æ€§å¾—åˆ†çš„å®šä¹‰
â€œå€¾å‘æ€§å¾—åˆ†â€ çš„å®šä¹‰å¾ˆç›´è§‚ï¼Œæ˜¯ä¸€ä¸ªç”¨æˆ·å±äºå®éªŒç»„çš„ â€œå€¾å‘æ€§â€ï¼š ğ‘’(ğ‘¥)=ğ‘ƒğ‘Ÿ[ğ‘‡=1|ğ‘‹=ğ‘¥]ã€‚
å€¾å‘æ€§å¾—åˆ†æ˜¯ä¸€ç§ â€œbalancing scoreâ€ã€‚
æ‰€æœ‰çš„ balancing score éƒ½æœ‰ä¸¤ä¸ªå¾ˆå¥½çš„æ€§è´¨ï¼Œå¯ä»¥æ€»ç»“ä¸ºä»¥ä¸‹ä¸¤ä¸ªå®šç†ã€‚
å¦‚æœæ„Ÿå…´è¶£è¯æ˜ï¼Œå¯ä»¥å‚è€ƒ Imbens & Rubin çš„ Causal Inference æ•™ç§‘ä¹¦ [4] ç¬¬åäºŒç« ã€‚

Theorem 1 (Balancing Property). ğ‘‡ğ‘–âŠ¥ğ‘‹ğ‘–|ğ‘’(ğ‘‹ğ‘–)ã€‚

Theorem 2 (Unconfoundedness). ğ‘‡ğ‘–âŠ¥ğ‘Œğ‘–0,ğ‘Œğ‘–1|ğ‘’(ğ‘‹ğ‘–)ã€‚

ç›´è§‚æ¥è¯´ï¼Œå¯¹äºå€¾å‘æ€§å¾—åˆ†ç›¸åŒçš„ä¸€ç¾¤ç”¨æˆ·ï¼Œtreatment å’Œç‰¹å¾æ˜¯ç‹¬ç«‹çš„ï¼Œtreatment å’Œæ½œåœ¨ç»“æœä¹Ÿæ˜¯ç‹¬ç«‹çš„ã€‚
å› æ­¤ï¼Œç†è®ºä¸Šï¼Œå¦‚æœæˆ‘ä»¬å¯¹æ¯ä¸€ä¸ªå®éªŒç»„ç”¨æˆ·éƒ½åœ¨å¯¹ç…§ç»„é‡ŒåŒ¹é…ä¸€ä¸ªå¾—åˆ†ç›¸ç­‰ï¼ˆè¦æ±‚æœ‰ç‚¹ä¸¥è‹›ï¼‰çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°åŒè´¨çš„å®éªŒç»„å’Œå¯¹ç…§ç»„ï¼Œå°±å¯ä»¥å‡è£…æˆ‘ä»¬åšäº†ä¸€ä¸ª A/B Test äº†ï¼Œæ¥ç€å°±å¯ä»¥éšæ„åœ°è¿›è¡Œç»„é—´æ¯”è¾ƒäº†ã€‚

ä¸Šé¢è¿™æ®µè¯å…·ä½“å®æ–½èµ·æ¥ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚

å€¾å‘æ€§å¾—åˆ†ä¼°ç®—ï¼šå€¾å‘æ€§å¾—åˆ†ä¸€èˆ¬æ¥è¯´æ˜¯æœªçŸ¥çš„ï¼Œæ€ä¹ˆä¼°ç®—ï¼Ÿ
å€¾å‘æ€§å¾—åˆ†åŒ¹é…ï¼šæ€ä¹ˆåŒ¹é…ï¼Ÿ
å¹³è¡¡æ€§æ£€æŸ¥ï¼šæ€ä¹ˆé‡åŒ–åŒ¹é…æ•ˆæœï¼Ÿ
å› æœæ•ˆåº”ä¼°ç®—ï¼šæ€ä¹ˆä»åŒ¹é…åçš„ä¸¤ç»„ç”¨æˆ·ä¸­å¾—åˆ°å› æœæ•ˆåº”ï¼Ÿ
æ•æ„Ÿåº¦åˆ†æï¼šåˆ†æç»“è®ºå¯¹äºæ··æ·†å˜é‡é€‰æ²¡é€‰å¯¹ï¼ˆä¸æ»¡è¶³ unconfoundedness ï¼‰æ˜¯ä¸æ˜¯å¾ˆæ•æ„Ÿï¼Ÿ
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹ã€‚

Step 1: å€¾å‘æ€§å¾—åˆ†ä¼°ç®—
è¿™ä¸€æ­¥è¯´ç™½äº†ï¼Œå°±æ˜¯ä¸€ä¸ªå»ºæ¨¡é—®é¢˜ã€‚
ä¸€èˆ¬æ¥è¯´ï¼ŒæŒ‰éœ€åšä¸€ä¸‹ç‰¹å¾é¢„å¤„ç†ï¼Œç„¶åå¥—ä¸€ä¸‹ LR å°±å¯ä»¥äº†ã€‚
å¦‚æœå‘ç°æŸäº›å˜é‡åŒ¹é…æ•ˆæœä¸å¥½ï¼ˆä¹‹åä¼šä»‹ç»å¦‚ä½•é‡åŒ– â€œåŒ¹é…æ•ˆæœâ€ï¼‰ï¼Œå¯ä»¥è€ƒè™‘åŠ å…¥ä¸€äº›é«˜é˜¶é¡¹ï¼Œä»è¿™ä¸€æ­¥é‡æ¥ä¸€éã€‚

ä¸ªäººä¹Ÿè¯•è¿‡ä½¿ç”¨ LR + LightGBM ä¼°ç®—å€¾å‘æ€§å¾—åˆ†ï¼Œç„¶åé€‰ AUC æ¯”è¾ƒé«˜çš„æ¨¡å‹ï¼Œåœ¨è‡ªå·±ç”Ÿæˆçš„ä»¿çœŸæ•°æ®ä¸Šçœ‹äº†ä¸€ä¸‹ï¼Œç¡®å®æ•ˆæœå¥½ä¸€äº›ã€‚
ä½†æ˜¯å…³äºå€¾å‘æ€§å¾—åˆ†ä¼°ç®—åˆ°åº•è¦ä¸è¦ä¸Šå¤æ‚æ¨¡å‹ï¼Œå…¶å®æ˜¯ä¸€ä¸ª
trade-offï¼Œå¦‚æœæ¯æ¬¡åšåˆ†æéƒ½è¦åšå‚æ•°ç½‘æ ¼æœç´¢ç”šè‡³éœ€è¦äººè‚‰è°ƒå‚ï¼Œå¥½åƒä¹Ÿä¸å¤ªå®é™…å¯¹å§ã€‚

Step 2: å€¾å‘æ€§å¾—åˆ†åŒ¹é…
å‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†æ¯ä¸ªç”¨æˆ·çš„å€¾å‘æ€§å¾—åˆ†ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯é’ˆå¯¹ç›®å‰çš„å®éªŒç»„ç”¨æˆ·ï¼ŒåŒ¹é…å¾—åˆ°ä¸€ä¸ªè¿‘ä¹äºåŒè´¨çš„å¯¹ç…§ç»„ã€‚

å½“ç”¨æˆ·é‡è¶³å¤Ÿæ—¶å€™ï¼Œä¸€ä¸ªç®€å•åšæ³•æ˜¯è¿›è¡Œä¸€å¯¹ä¸€æ— æ”¾å›åŒ¹é…ï¼šå¯¹äºæ¯ä¸€ä¸ªå®éªŒç»„ç”¨æˆ·ï¼Œæˆ‘ä»¬å»å¯¹ç…§ç»„é‡Œæ‰¾ä¸€ä¸ªå€¾å‘æ€§å¾—åˆ†æœ€è¿‘çš„ç”¨æˆ·ï¼ŒæŠŠä»–ä»¬é…æˆä¸€å¯¹ã€‚åŒ¹é…è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é™åˆ¶ä¸€ä¸‹é…å¯¹ç”¨æˆ·çš„å¾—åˆ†å·®å¼‚ä¸èƒ½è¶…è¿‡æŸä¸€ä¸ªé˜ˆå€¼ï¼Œé…ä¸ä¸Šå°±ç®—äº†ï¼Œä»¥é˜²æŠŠ â€œå¤ªä¸ç›¸ä¼¼â€ çš„ç”¨æˆ·åŒ¹é…åœ¨ä¸€èµ·ã€‚

åœ¨å®ç°åŒ¹é…æ—¶ï¼Œæœ‰å¾ˆå¤šç»†èŠ‚æœ‰å¾ˆå¤šé€‰é¡¹ï¼Œä¸‹é¢åˆ—ä¸€ä¸‹ä¸ªäººè®¤ä¸ºæ¯”è¾ƒå¸¸è§çš„ã€‚
å’Œæœºå™¨å­¦ä¹ é‡Œè°ƒæ¯ä¸ªå‚æ•°éƒ½å¯¹åº”ç€æŸäº› trade-off ç±»ä¼¼ï¼Œè¿™é‡Œæ¯ä¸ªé€‰é¡¹èƒŒåä¹Ÿéƒ½æœ‰å¯¹åº”çš„ bias-variance çš„ trade-off çš„ï¼Œå°±ä¸ç»†è¯´ã€‚

åŒ¹é…ç”¨çš„å¾—åˆ†ï¼šå¯é€‰åŸå§‹å€¾å‘æ€§å¾—åˆ† ğ‘’(ğ‘¥) æˆ–è€…å¾—åˆ†çš„ logit
ğ‘™(ğ‘¥)=ğ‘™ğ‘›(ğ‘’(ğ‘¥)/(1âˆ’ğ‘’(ğ‘¥)))ï¼Œæ¥ä¸‹æ¥éƒ½ç»Ÿä¸€ç”¨ ğ‘’ è¡¨ç¤ºã€‚
ä¿®å‰ªï¼ˆtrimmingï¼‰ï¼šç§‰æ‰¿ç€ â€œå¸Œæœ›ä¸‹ä¸€ä¸ªé€šç”¨çš„ç»“è®ºâ€ çš„æ€è·¯ï¼Œå¯ä»¥å…ˆç­›é€‰æ‰å€¾å‘æ€§å¾—åˆ†æ¯”è¾ƒ â€œæç«¯â€ çš„ç”¨æˆ·ï¼Œä¾‹å¦‚åœ¨ç°å®ä¸­ä¸å¤§å¯èƒ½å‡ºç°åœ¨å®éªŒç»„é‡Œçš„å¯¹ç…§ç»„ç”¨æˆ·ã€‚å¸¸è§çš„åšæ³•æ˜¯ä¿ç•™å¾—åˆ†åœ¨ [ğ‘’ğ‘šğ‘–ğ‘›,ğ‘’ğ‘šğ‘ğ‘¥] è¿™ä¸ªåŒºé—´çš„ç”¨æˆ·ï¼Œå…³äºåŒºé—´é€‰æ‹©ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ªä¾‹å­ã€‚
å®éªŒç»„å’Œå¯¹ç…§ç»„ç”¨æˆ·å¾—åˆ†åŒºé—´çš„äº¤é›†
åªä¿ç•™åŒºé—´ä¸­éƒ¨ 90% æˆ–è€… 95%ï¼Œå¦‚å–åŸå§‹å¾—åˆ†åœ¨ [0.05,0.95] çš„ç”¨æˆ·
åŒ¹é…ï¼ˆmatching)ï¼šå®éªŒç»„å¯¹å¯¹ç…§ç»„æ ¹æ®å¾—åˆ†è¿›è¡ŒåŒ¹é…æ—¶å€™ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ã€‚
nearest neighbors: è¿›è¡Œ 1 å¯¹ K æœ‰æ”¾å›æˆ–æ— æ”¾å›åŒ¹é…
radius: å¯¹æ¯ä¸ªå®éªŒç»„ç”¨æˆ·ï¼ŒåŒ¹é…ä¸Šæ‰€æœ‰å¾—åˆ†å·®å¼‚å°äºæŒ‡å®š radius çš„ç”¨æˆ·
å¾—åˆ†å·®å¼‚ä¸Šé™ï¼ˆcaliperï¼‰ï¼šå½“æˆ‘ä»¬åŒ¹é…ç”¨æˆ·çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æ±‚æ¯ä¸€å¯¹ç”¨æˆ·çš„å¾—åˆ†å·®å¼‚ä¸è¶…è¿‡æŒ‡å®š
çš„ caliperï¼Œâ€œå¼ºæ‰­çš„ç“œä¸ç”œâ€ï¼ŒåŒ¹é…ä¸å¥½å°±ä¸è¦æ”¾å¼ƒå§ã€‚
æ¥ä¸‹é€šè¿‡çŸ­çŸ­å‡ è¡Œçš„ä»£ç ï¼Œé…å¹³ä¸€ä¸‹ç»å…¸æ•°æ®é›† NSW-Data-Obsã€‚
MatchIt ä¼šå¸®æˆ‘ä»¬ä¼°ç®—å¥½å€¾å‘æ€§å¾—åˆ†ï¼Œå†è¿›è¡ŒåŒ¹é…ã€‚
å‚æ•°çš„åå­—éƒ½å¾ˆç›´è§‚ï¼Œå°±ä¸å” å¨ã€‚
è‡³äºå‚æ•°æ˜¯æ€ä¹ˆé€‰çš„ï¼Œè¿™æ˜¯æˆ‘é…æ¥é…å»ï¼Œå‘ç° â€œé…å¹³æ•ˆæœâ€ æœ€å¥½çš„ä¸€ç»„å‚æ•°ã€‚

set.seed(42)
m.out <- matchit(data = nsw_data_obs,
                 formula = treat ~ age + I(age^2) + I(age^3) + educ + black + hispan + married +
                                I(re74/1000) + I(re75/1000),
                 method = "nearest",
                 distance = "logit",
                 replace = FALSE,
                 caliper = 0.05)
Step 3: å¹³è¡¡æ€§æ£€æŸ¥
æ€ä¹ˆè¡¡é‡ â€œé…å¹³æ•ˆæœ â€œå‘¢ï¼Ÿ

æ¯”è¾ƒç›´è§‚çš„æ˜¯çœ‹å€¾å‘æ€§å¾—åˆ†åœ¨åŒ¹é…å‰åçš„åˆ†å¸ƒã€ä»¥åŠç‰¹å¾åœ¨åŒ¹é…å‰åçš„ QQ-Plotã€‚
MatchIt è‡ªå¸¦äº†è¿™äº›ï¼Œä¸¤è¡Œä»£ç æå®šã€‚

ä¸‹é¢ä¸¤å¼ å›¾é‡Œæ˜¯ NSW-Data-Obs çš„é…å¹³ç»“æœã€‚
å¯ä»¥çœ‹å‡ºï¼ŒåŒ¹é…åçš„å®éªŒç»„å’Œå¯¹ç…§ç»„çš„å€¾å‘æ€§å¾—åˆ†åˆ†å¸ƒæ›´åŠ æ¥è¿‘ï¼Œå˜é‡åˆ†å¸ƒä¹Ÿæ›´æ¥è¿‘ã€‚
å…¶å®åŒ¹é…åçš„ â€œå€¾å‘æ€§å¾—åˆ†â€ åˆ†å¸ƒå¹¶ä¸æ˜¯éå¸¸å®Œç¾ï¼Œè¿™ä¸ªæ•°æ®é‡Œçš„æ ·æœ¬å®åœ¨æ˜¯å¤ªå°‘äº†ã€‚

plot(m.out, type = "hist", interactive = F)
plot(m.out, type = "QQ", interactive = F, which.xs = c("age", "I(re74/1000)", "I(re75/1000)"))

çœ‹å›¾æ¯•ç«Ÿè¿˜æ˜¯ä¸å¤Ÿç›´è§‚ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é…å¹³æ•ˆæœçš„é‡åŒ–æŒ‡æ ‡ã€‚
Coursera ä¸Šçš„å…¬å¼€è¯¾ â€œA Crash Course in Causality: Inferring Causal Effects from
Observational Dataâ€ é‡Œä»‹ç»äº†é‡åŒ–æŒ‡æ ‡ Standarized Mean Difference (SMD)ã€‚
SMD çš„ä¸€ç§è®¡ç®—æ–¹å¼ä¸ºï¼šï¼ˆå®éªŒç»„å‡å€¼ - å¯¹ç…§ç»„å‡å€¼ï¼‰/ å®éªŒç»„æ ‡å‡†å·®ã€‚
å…¬å¼€è¯¾é‡Œçš„æ•™æˆè¯´ï¼Œä¸€èˆ¬å¦‚æœä¸€ä¸ªå˜é‡çš„ SMD ä¸è¶…è¿‡ 0.1ï¼Œä¸€èˆ¬å°±å¯ä»¥è®¤ä¸ºè¿™ä¸ªå˜é‡çš„é…å¹³è´¨é‡å¯ä»¥æ¥å—ã€‚
å½“ä¸€ä¸ªå˜é‡çš„ SMD è¶…è¿‡ 0.1 çš„æ—¶å€™ï¼Œéœ€è¦å‡­ç»éªŒç¡®è®¤ä¸€ä¸‹é‚£ä¸ªå˜é‡æ˜¯ä¸æ˜¯æ²¡æœ‰é‚£ä¹ˆé‡è¦ã€‚

MatchIt é‡Œè‡ªå¸¦äº†ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥è®¡ç®—é…å¹³å‰åæ¯ä¸ªå˜é‡çš„å„ç±»ç»Ÿè®¡ç»“æœï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬äº† SMDã€‚
è¿™é‡Œæˆ‘ä»¬åªçœ‹çœ‹é…å¹³åçš„æ•ˆæœã€‚
é…å¹³å SMD ç»å¯¹å€¼çš„æœ€å¤§å€¼æ˜¯ 0.09ï¼Œå¯ä»¥è®¤ä¸ºé…å¹³è´¨é‡å¯ä»¥æ¥å—ã€‚

summary(m.out, standardize = T)$sum.matched
Means Treated	Means Control	SD Control	Std. Mean Diff.	eCDF Med	eCDF Mean	eCDF Max
distance	0.48	0.47	0.25	0.03	0.01	0.01	0.04
age	25.28	24.79	8.40	0.07	0.02	0.02	0.08
I(age^2)	702.42	684.28	518.77	0.04	0.02	0.02	0.08
I(age^3)	21480.53	21211.74	26553.46	0.01	0.02	0.02	0.08
educ	10.21	10.03	2.98	0.09	0.04	0.05	0.12
black	0.69	0.72	0.45	-0.06	0.01	0.01	0.02
hispan	0.12	0.11	0.31	0.04	0.01	0.01	0.01
married	0.26	0.25	0.44	0.03	0.01	0.01	0.01
I(re74/1000)	2.50	2.59	4.16	-0.02	0.05	0.10	0.33
I(re75/1000)	1.76	1.94	3.12	-0.05	0.02	0.04	0.16
Step 4: å› æœæ•ˆåº”æ¨æ–­
æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ¨æ–­ ATT (Average Treatment Effect on the Treated)ã€‚
å›é¡¾ä¸€ä¸‹ï¼ŒATT çš„å®šä¹‰ä¸º ğ´ğ‘‡ğ‘‡=ğ¸[ğ‘Œ1âˆ’ğ‘Œ0|ğ‘‡=1]ã€‚
ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰ä¸€å¯¹æ¥è¿‘åŒè´¨çš„å®éªŒç»„å’Œå¯¹ç…§ç»„äº†ï¼Œæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥ç”¨æ¥ä¼°ç®— ATT ã€‚
ä¸ªäººæ„Ÿè§‰ä¸¤ç§æ¯”è¾ƒç›´è§‚æ˜¯ï¼š

ç›´æ¥æ¯”è¾ƒåŒ¹é…åçš„å®éªŒç»„å’Œå¯¹ç…§ç»„
æ‹Ÿåˆä¸€ä¸ªç”±å¹²é¢„å’Œç”¨æˆ·ç‰¹å¾é¢„æµ‹è§‚å¯Ÿç»“æœçš„çº¿å½¢æ¨¡å‹ï¼Œçœ‹çœ‹å¹²é¢„ ğ‘‡ çš„ç³»æ•°æ˜¯å¤šå°‘
â€¦â€¦
å¯¹äº NSW-Data-obsï¼Œä»¥ä¸Šä¸¤ç§æ–¹æ³•ä¼°ç®—çš„ ATT ç»“æœéƒ½å·®ä¸å¤šï¼Œå¤§è‡´ä¸º 1900 åˆ° 2000 ç¾é‡‘ï¼Œå’Œ 1794 ç¾é‡‘è¿™ä¸ª ground truth å·®ä¸å¤ªå¤šï¼ˆæ¯•ç«Ÿä¸é…å¹³ç›´æ¥ä¼°ç®—æ˜¯ - 635 ç¾é‡‘å•Šï¼‰ã€‚

æ–¹æ³•	ATT	ATT æ ‡å‡†å·®	ATT 95% ç½®ä¿¡åŒºé—´
ç›´æ¥æ¯”è¾ƒ	1986	1062	(-112, 4083)
æ‹Ÿåˆ ğ‘Œ=ğ‘‡+ğ‘‹	1907	1075	(-215, 4029)
ä»£ç å¦‚ä¸‹ï¼ˆMatchIt å·²ç»å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œè¿™ä¸€éƒ¨åˆ†å°±å¾—è‡ªå·±å†™äº†ï¼‰ã€‚

m.data <- match.data(m.out)

# Direct compare
res <- wtd.t.test(m.data$re78[m.data$treat == 1],
                  m.data$re78[m.data$treat == 0],
                  weight = m.data$weights[m.data$treat == 1],
                  weighty = m.data$weights[m.data$treat == 0])
print(res)
mu <- res$additional[1]
std <- res$additional[4]
cat("Confidence interval: ", sapply(qt(c(0.025, 0.975), coef(res)["df"]), function(x){return(mu+x*std)}), "\n")

# Fit
att.fml <- re78 ~ treat + age + educ + black + hispan + married + nodegree + re74 + re75
fit <- lm(att.fml, data = m.data, weights = m.data$weights)
summary(fit)
cat("Confidence interval: ", confint(fit, "treat", 0.95), "\n")
Step 5: æ•æ„Ÿæ€§æ£€æŸ¥
æ•æ„Ÿæ€§åˆ†æçš„æ–¹æ³•æ˜¯ç‹¬ç«‹äºå€¾å‘æ€§å¾—åˆ†åŒ¹é…çš„ã€‚
ä¸»è¦çš„ç›®æ ‡æ˜¯è¡¡é‡å½“æ··æ·†å˜é‡ï¼ˆç‰¹å¾ï¼‰ä¸æ»¡è¶³ unconfoundedness æ—¶ï¼Œåˆ†æç»“è®ºæ˜¯ä¸æ˜¯ robustã€‚
ä¸€ä¸ªç®€å•çš„åšæ³•æ˜¯å»æ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ··æ·†å˜é‡é‡å¤ä¸Šé¢çš„è¿‡ç¨‹ï¼Œå¦‚æœåˆ†æç»“è®ºç¿»è„¸å¦‚ç¿»ä¹¦ï¼Œè¯´æ˜
unconfoundedness è¦ä¹ˆä¾èµ–äºæ‰€æœ‰ç‰¹å¾ï¼Œè¦ä¹ˆä¸æˆç«‹ã€‚

å…¶å®ƒæ›´ç³»ç»Ÿçš„æ•æ„Ÿæ€§æ£€æŸ¥æ–¹æ¡ˆï¼Œè¿˜åœ¨å­¦ä¹ ä¸­ï¼Œä¹‹åå†å†™ä¸€ç¯‡ã€‚

å€¾å‘æ€§å¾—åˆ†åŒ¹é…ç»¼è¿°
å…³äºå€¾å‘æ€§å¾—åˆ†åŒ¹é…ï¼Œæœ‰ä¸€ç¯‡å¼•ç”¨è¶…è¿‡ 4000 çš„ Some practical guidance for the implementation of propensity score matching [5]ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è¯»ä¸€è¯»ã€‚ä¸Šé¢æ‰€å†™ï¼Œåªæ˜¯å…¶ä¸­çš„ä¸€ä¸ªå°å°å­é›†ã€‚

å€¾å‘æ€§å¾—åˆ†çš„å…¶å®ƒæ‰“å¼€æ–¹å¼
å€¾å‘æ€§å¾—åˆ†é™¤äº†ç”¨æ¥åŒ¹é…ï¼Œè¿˜æœ‰å…¶å®ƒçš„ç”¨æ³•ã€‚
ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å€¾å‘æ€§å¾—åˆ†æ¥å¯¹ç”¨æˆ·è¿›è¡Œåˆ†ç»„ï¼Œç§°ä¸º subclassificationã€‚
æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å€¾å‘æ€§å¾—åˆ†æ¥å¯¹ç”¨æˆ·è¿›è¡ŒåŠ æƒï¼Œç§°ä¸º Inverse Propensity Score Weighting (IPSW)ã€‚
ä¸‡å˜ä¸ç¦»å…¶ä¸­ï¼Œç›®æ ‡éƒ½æ˜¯ä¸ºäº†æ¶ˆé™¤ä¸¤ç»„ç”¨æˆ·çš„ä¸åŒè´¨å¯¼è‡´çš„åˆ†æåå·®ã€‚

å°ç»“
è¿™ä¸€ç¯‡æ–‡ç« ä»‹ç»äº† â€œå€¾å‘æ€§å¾—åˆ†åŒ¹é…â€ è¿™ä¸ªæ–¹æ³•ã€‚
è¿™ä¸ªæ–¹æ³•çš„æœ¬è´¨ç›®æ ‡æ˜¯æ¶ˆé™¤è§‚å¯Ÿæ€§ç ”ç©¶ä¸­å®éªŒç»„å’Œå¯¹ç…§ç»„ç”¨æˆ·çš„ä¸åŒè´¨ï¼Œè¿›è€Œå¾—åˆ°å› æœæ•ˆåº”çš„ä¼°ç®—ã€‚

æ–¹æ³•æ€è·¯è™½ç„¶ç®€å•ï¼ŒçœŸæ­£ä½¿ç”¨èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹è®©äººä¸çŸ¥æ‰€æªï¼Œå…‰æ˜¯åŒ¹é…å‚æ•°ï¼ˆtrimmingã€åŒ¹é…æ–¹æ³•ã€caliper ç­‰ç­‰ï¼‰å°±æœ‰å¥½å¤šä¸åŒçš„é€‰æ‹©ï¼Œè¿˜æ˜¯éœ€è¦å¤šåŠ ç»ƒä¹ ã€‚
åˆšåˆšå…¥é—¨ï¼Œå¦‚æœæœ‰å“ªä½å¥½å¿ƒäººæœ‰ä»€ä¹ˆç³»ç»Ÿæ€§åœ°é€‰æ‹©åŒ¹é…æ–¹æ³•çš„æ–¹æ³•ï¼Œè¿˜è¯·å¤šå¤šæŒ‡æ•™ã€‚

å‚è€ƒèµ„æ–™
LaLonde R J. Evaluating the econometric evaluations of training programs with experimental data[J]. The American economic review, 1986: 604-620.
Dehejia R H, Wahba S. Causal effects in nonexperimental studies: Reevaluating the evaluation of training programs[J]. Journal of the American statistical Association, 1999, 94(448): 1053-1062.
Dehejia R H, Wahba S. Propensity score-matching methods for nonexperimental causal studies[J]. Review of Economics and statistics, 2002, 84(1): 151-161.
Imbens G W, Rubin D B. Causal inference in statistics, social, and biomedical sciences[M]. Cambridge University Press, 2015.
Caliendo M, Kopeinig S. Some practical guidance for the implementation of propensity score matching[J]. Journal of economic surveys, 2008, 22(1): 31-72.
MatchIt æ–‡æ¡£ï¼šhttps://r.iq.harvard.edu/docs/matchit/2.4-20/matchit.pdf
